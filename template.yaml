# AWS SAM Template for Local Lambda Execution
# Derived from CDK Stack: infrastructure/lib/pivotr-mailer-stack.ts
#
# This template enables local Lambda execution using SAM CLI.
# It mirrors the production CDK configuration for high-fidelity testing.
#
# Usage:
#   sam build
#   sam local invoke SendEmailLambda --event events/sqs/send-email.json
#   sam local start-api --docker-network localstack-network

AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Pivotr Mailer - Local Testing Template

# =============================================================================
# GLOBALS - Shared configuration across all functions
# =============================================================================
Globals:
  Function:
    Runtime: nodejs20.x
    Architectures:
      - x86_64
    Timeout: 30
    MemorySize: 256
    Environment:
      Variables:
        # AWS SDK Configuration for LocalStack
        AWS_ENDPOINT_URL: !Ref AWSEndpointUrl
        AWS_REGION: !Ref AWSRegion
        # DynamoDB Tables
        DYNAMODB_TABLE_LEADS: !Ref LeadsTableName
        DYNAMODB_TABLE_CAMPAIGNS: !Ref CampaignsTableName
        DYNAMODB_TABLE_METRICS: !Ref MetricsTableName
        DYNAMODB_TABLE_LOGS: !Ref LogsTableName
        DYNAMODB_TABLE_SETTINGS: !Ref SettingsTableName
        # SQS Queues
        SQS_QUEUE_SENDING: !Ref SendingQueueUrl
        SQS_QUEUE_FEEDBACK: !Ref FeedbackQueueUrl
        SQS_QUEUE_VERIFICATION: !Ref VerificationQueueUrl
        # General
        LOG_LEVEL: !Ref LogLevel
        ENVIRONMENT: local

# =============================================================================
# PARAMETERS - Configurable for different environments
# =============================================================================
Parameters:
  AWSEndpointUrl:
    Type: String
    Default: "http://host.docker.internal:4566"
    Description: LocalStack endpoint URL (use host.docker.internal for Docker-to-Docker)

  AWSRegion:
    Type: String
    Default: "us-east-1"
    Description: AWS region for LocalStack

  # CORS Configuration
  # Note: For local development, use '*' to allow all origins
  # In production, this should be set to the specific frontend domain
  CorsAllowedOrigin:
    Type: String
    Default: "*"
    Description: Allowed CORS origin (use '*' for development, specific domain for production)

  # Throttling Configuration (Conservative for 2 users)
  ThrottlingBurstLimit:
    Type: Number
    Default: "5"
    Description: API Gateway throttling burst limit (requests per second)

  ThrottlingRateLimit:
    Type: Number
    Default: "2"
    Description: API Gateway throttling steady-state rate limit (requests per second)

  # Usage Plan Configuration (Conservative for 2 users)
  UsagePlanQuotaLimit:
    Type: Number
    Default: "1000"
    Description: Monthly quota limit for API usage (conservative for 2 users)

  UsagePlanQuotaPeriod:
    Type: String
    Default: "MONTH"
    AllowedValues:
      - DAY
      - WEEK
      - MONTH
    Description: Quota period for API usage

  LeadsTableName:
    Type: String
    Default: "pivotr-leads"
    Description: DynamoDB Leads table name

  CampaignsTableName:
    Type: String
    Default: "pivotr-campaigns"
    Description: DynamoDB Campaigns table name

  MetricsTableName:
    Type: String
    Default: "pivotr-metrics"
    Description: DynamoDB Metrics table name

  LogsTableName:
    Type: String
    Default: "pivotr-logs"
    Description: DynamoDB Logs table name

  SettingsTableName:
    Type: String
    Default: "pivotr-settings"
    Description: DynamoDB Settings table name

  SendingQueueUrl:
    Type: String
    Default: "http://host.docker.internal:4566/000000000000/sending-queue"
    Description: SQS Sending Queue URL

  FeedbackQueueUrl:
    Type: String
    Default: "http://host.docker.internal:4566/000000000000/feedback-queue"
    Description: SQS Feedback Queue URL

  VerificationQueueUrl:
    Type: String
    Default: "http://host.docker.internal:4566/000000000000/verification-queue"
    Description: SQS Verification Queue URL

  LogLevel:
    Type: String
    Default: "DEBUG"
    AllowedValues:
      - DEBUG
      - INFO
      - WARN
      - ERROR
    Description: Log level for Lambda functions

# =============================================================================
# RESOURCES - Lambda Functions and API Gateway
# =============================================================================
Resources:

  # ===========================================================================
  # Shared Utils Layer
  # ===========================================================================
  # This layer provides shared utilities (logger, clients, config, errors)
  # to all Lambda functions. Changes to lambda/shared/ trigger layer rebuild.
  # Using nodejs20.x BuildMethod for proper hot reload support per AWS SAM docs.
  SharedUtilsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: pivotr-shared-utils
      Description: Shared utilities for Pivotr Mailer Lambda functions
      ContentUri: lambda/shared/
      CompatibleRuntimes:
        - nodejs20.x
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: nodejs20.x
      BuildArchitecture: x86_64

  # ===========================================================================
  # API Gateway
  # ===========================================================================
  PivotrMailerApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: v1
      Description: Pivotr Mailer REST API

      # Throttling Configuration (10 RPS burst, 5 RPS steady-state)
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          ThrottlingBurstLimit: !Ref ThrottlingBurstLimit
          ThrottlingRateLimit: !Ref ThrottlingRateLimit
          LoggingLevel: INFO
          DataTraceEnabled: false
          MetricsEnabled: true

      # CORS Configuration - Allow all origins for development
      # Note: For AWS::Serverless::Api, Cors values should NOT have embedded quotes
      Cors:
        AllowMethods: "GET,POST,PUT,DELETE,OPTIONS"
        AllowHeaders: "Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token"
        AllowOrigin: !Ref CorsAllowedOrigin
        MaxAge: "86400"

      # Request Models for Validation
      Models:
        LeadModel:
          type: object
          required:
            - email
          properties:
            email:
              type: string
              format: email
              maxLength: 254
            firstName:
              type: string
              maxLength: 100
            lastName:
              type: string
              maxLength: 100
            company:
              type: string
              maxLength: 200
            status:
              type: string
              enum:
                - pending
                - verified
                - invalid
                - bounced

        CampaignModel:
          type: object
          required:
            - name
            - subject
            - body
          properties:
            name:
              type: string
              minLength: 1
              maxLength: 200
            subject:
              type: string
              minLength: 1
              maxLength: 500
            body:
              type: string
              minLength: 1
              maxLength: 50000
            status:
              type: string
              enum:
                - draft
                - scheduled
                - running
                - paused
                - completed
                - cancelled

        AssignLeadsModel:
          type: object
          required:
            - leadIds
          properties:
            leadIds:
              type: array
              items:
                type: string
              minItems: 1
              maxItems: 100

        StatusUpdateModel:
          type: object
          required:
            - status
          properties:
            status:
              type: string
              enum:
                - draft
                - scheduled
                - running
                - paused
                - completed
                - cancelled

        TestEmailModel:
          type: object
          required:
            - recipientEmail
          properties:
            recipientEmail:
              type: string
              format: email

        ImportLeadsModel:
          type: object
          required:
            - leads
          properties:
            leads:
              type: array
              items:
                type: object
                required:
                  - email
                properties:
                  email:
                    type: string
                    format: email
              minItems: 1
              maxItems: 500

        ErrorModel:
          type: object
          properties:
            message:
              type: string
            errorCode:
              type: string
            requestId:
              type: string

      # Gateway Responses - Standardized Error Responses
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: !Ref CorsAllowedOrigin
              Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key'"
          ResponseTemplates:
            application/json: '{"message": "$context.error.messageString", "errorCode": "CLIENT_ERROR", "requestId": "$context.requestId"}'

        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: !Ref CorsAllowedOrigin
              Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key'"
          ResponseTemplates:
            application/json: '{"message": "Internal server error", "errorCode": "SERVER_ERROR", "requestId": "$context.requestId"}'

        BAD_REQUEST_BODY:
          StatusCode: 400
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: !Ref CorsAllowedOrigin
          ResponseTemplates:
            application/json: '{"message": "Invalid request body", "errorCode": "VALIDATION_ERROR", "requestId": "$context.requestId"}'

        THROTTLED:
          StatusCode: 429
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: !Ref CorsAllowedOrigin
              Retry-After: "'60'"
          ResponseTemplates:
            application/json: '{"message": "Rate limit exceeded. Please retry after 60 seconds.", "errorCode": "RATE_LIMIT_EXCEEDED", "requestId": "$context.requestId"}'

        QUOTA_EXCEEDED:
          StatusCode: 429
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: !Ref CorsAllowedOrigin
          ResponseTemplates:
            application/json: '{"message": "API quota exceeded", "errorCode": "QUOTA_EXCEEDED", "requestId": "$context.requestId"}'

        MISSING_AUTHENTICATION_TOKEN:
          StatusCode: 403
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: !Ref CorsAllowedOrigin
          ResponseTemplates:
            application/json: '{"message": "Missing or invalid API key", "errorCode": "MISSING_API_KEY", "requestId": "$context.requestId"}'

        INVALID_API_KEY:
          StatusCode: 403
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: !Ref CorsAllowedOrigin
          ResponseTemplates:
            application/json: '{"message": "Invalid API key", "errorCode": "INVALID_API_KEY", "requestId": "$context.requestId"}'

        RESOURCE_NOT_FOUND:
          StatusCode: 404
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: !Ref CorsAllowedOrigin
          ResponseTemplates:
            application/json: '{"message": "Resource not found", "errorCode": "NOT_FOUND", "requestId": "$context.requestId"}'

  # ===========================================================================
  # Usage Plan and API Key
  # ===========================================================================
  PivotrApiUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    DependsOn: PivotrMailerApiv1Stage
    Properties:
      UsagePlanName: PivotrMailerUsagePlan
      Description: Usage plan for Pivotr Mailer API
      ApiStages:
        - ApiId: !Ref PivotrMailerApi
          Stage: v1
      Quota:
        Limit: !Ref UsagePlanQuotaLimit
        Period: !Ref UsagePlanQuotaPeriod
      Throttle:
        BurstLimit: !Ref ThrottlingBurstLimit
        RateLimit: !Ref ThrottlingRateLimit

  PivotrApiKey:
    Type: AWS::ApiGateway::ApiKey
    DependsOn: PivotrMailerApiv1Stage
    Properties:
      Name: PivotrMailerApiKey
      Description: API Key for Pivotr Mailer
      Enabled: true
      StageKeys:
        - RestApiId: !Ref PivotrMailerApi
          StageName: v1

  PivotrApiUsagePlanKey:
    Type: AWS::ApiGateway::UsagePlanKey
    Properties:
      KeyId: !Ref PivotrApiKey
      KeyType: API_KEY
      UsagePlanId: !Ref PivotrApiUsagePlan

  # ===========================================================================
  # API Lambda Functions
  # ===========================================================================

  ApiLeadsLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: pivotr-api-leads
      Handler: index.handler
      CodeUri: lambda/api/leads/
      Layers:
        - !Ref SharedUtilsLayer
      Timeout: 10
      MemorySize: 256
      ReservedConcurrentExecutions: 2
      Events:
        GetLeads:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /leads
            Method: GET
        CreateLead:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /leads
            Method: POST
            RequestModel:
              Model: LeadModel
              Required: true
              ValidateBody: true
        GetLead:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /leads/{id}
            Method: GET
            RequestParameters:
              - method.request.path.id:
                  Required: true
        UpdateLead:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /leads/{id}
            Method: PUT
            RequestModel:
              Model: LeadModel
              Required: true
              ValidateBody: true
            RequestParameters:
              - method.request.path.id:
                  Required: true
        DeleteLead:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /leads/{id}
            Method: DELETE
            RequestParameters:
              - method.request.path.id:
                  Required: true
        BulkDeleteLeads:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /leads/bulk-delete
            Method: POST
        BulkUpdateLeads:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /leads/bulk-update
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        Minify: false
        Target: es2022
        External:
          - "@aws-sdk/*"
          - "@aws-lambda-powertools/*"
        Format: esm
        OutExtension:
          - .js=.mjs

  ApiCampaignsLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: pivotr-api-campaigns
      Handler: index.handler
      CodeUri: lambda/api/campaigns/
      Layers:
        - !Ref SharedUtilsLayer
      Timeout: 10
      MemorySize: 256
      ReservedConcurrentExecutions: 2
      Environment:
        Variables:
          SQS_VERIFICATION_QUEUE_URL: !Ref VerificationQueueUrl
          SES_FROM_EMAIL: noreply@pivotr.local
          SES_CONFIGURATION_SET: PivotrLocalConfigSet
      Events:
        GetCampaigns:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /campaigns
            Method: GET
        CreateCampaign:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /campaigns
            Method: POST
            RequestModel:
              Model: CampaignModel
              Required: true
              ValidateBody: true
        PreviewLeads:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /campaigns/preview-leads
            Method: POST
        GetCampaign:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /campaigns/{id}
            Method: GET
            RequestParameters:
              - method.request.path.id:
                  Required: true
        UpdateCampaign:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /campaigns/{id}
            Method: PUT
            RequestModel:
              Model: CampaignModel
              Required: true
              ValidateBody: true
            RequestParameters:
              - method.request.path.id:
                  Required: true
        DeleteCampaign:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /campaigns/{id}
            Method: DELETE
            RequestParameters:
              - method.request.path.id:
                  Required: true
        GetCampaignLeads:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /campaigns/{id}/leads
            Method: GET
            RequestParameters:
              - method.request.path.id:
                  Required: true
        AssignLeads:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /campaigns/{id}/assign-leads
            Method: POST
            RequestModel:
              Model: AssignLeadsModel
              Required: true
              ValidateBody: true
            RequestParameters:
              - method.request.path.id:
                  Required: true
        UpdateStatus:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /campaigns/{id}/status
            Method: PUT
            RequestModel:
              Model: StatusUpdateModel
              Required: true
              ValidateBody: true
            RequestParameters:
              - method.request.path.id:
                  Required: true
        TestEmail:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /campaigns/{id}/test-email
            Method: POST
            RequestModel:
              Model: TestEmailModel
              Required: true
              ValidateBody: true
            RequestParameters:
              - method.request.path.id:
                  Required: true
        GetCampaignMetrics:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /campaigns/{id}/metrics
            Method: GET
            RequestParameters:
              - method.request.path.id:
                  Required: true
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        Minify: false
        Target: es2022
        External:
          - "@aws-sdk/*"
          - "@aws-lambda-powertools/*"
        Format: esm
        OutExtension:
          - .js=.mjs

  ApiMetricsLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: pivotr-api-metrics
      Handler: index.handler
      CodeUri: lambda/api/metrics/
      Layers:
        - !Ref SharedUtilsLayer
      Timeout: 10
      MemorySize: 256
      ReservedConcurrentExecutions: 2
      Events:
        GetMetrics:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /metrics
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        Minify: false
        Target: es2022
        External:
          - "@aws-sdk/*"
          - "@aws-lambda-powertools/*"
        Format: esm
        OutExtension:
          - .js=.mjs

  ApiLeadsExportLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: pivotr-api-leads-export
      Handler: index.handler
      CodeUri: lambda/api/leads-export/
      Layers:
        - !Ref SharedUtilsLayer
      Timeout: 20
      MemorySize: 1024
      ReservedConcurrentExecutions: 1
      Events:
        ExportLeads:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /leads/export
            Method: POST
        ExportSelectedLeads:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /leads/export-selected
            Method: POST
        GetTemplate:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /leads/template
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        Minify: false
        Target: es2022
        External:
          - "@aws-sdk/*"
          - "@aws-lambda-powertools/*"
        Format: esm
        OutExtension:
          - .js=.mjs

  LeadImportLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: pivotr-lead-import
      Handler: index.handler
      CodeUri: lambda/lead-import/
      Layers:
        - !Ref SharedUtilsLayer
      Timeout: 60
      MemorySize: 512
      ReservedConcurrentExecutions: 1
      Events:
        ImportLeads:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /leads/import
            Method: POST
            RequestModel:
              Model: ImportLeadsModel
              Required: true
              ValidateBody: true
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        Minify: false
        Target: es2022
        External:
          - "@aws-sdk/*"
          - "@aws-lambda-powertools/*"
        Format: esm
        OutExtension:
          - .js=.mjs

  # ===========================================================================
  # SQS-Triggered Lambda Functions
  # ===========================================================================

  SendEmailLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: pivotr-send-email
      Handler: index.handler
      CodeUri: lambda/send-email/
      Layers:
        - !Ref SharedUtilsLayer
      Timeout: 30
      MemorySize: 256
      ReservedConcurrentExecutions: 2
      Environment:
        Variables:
          SES_FROM_EMAIL: noreply@pivotr.local
          SES_CONFIGURATION_SET: PivotrLocalConfigSet
      # Note: SQS event source requires actual queue ARN in production
      # For local testing, we invoke directly or use LocalStack triggers
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        Minify: false
        Target: es2022
        External:
          - "@aws-sdk/*"
          - "@aws-lambda-powertools/*"
        Format: esm
        OutExtension:
          - .js=.mjs

  VerifyEmailLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: pivotr-verify-email
      Handler: index.handler
      CodeUri: lambda/verify-email/
      Layers:
        - !Ref SharedUtilsLayer
      Timeout: 15
      MemorySize: 256
      ReservedConcurrentExecutions: 2
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        Minify: false
        Target: es2022
        External:
          - "@aws-sdk/*"
          - "@aws-lambda-powertools/*"
        Format: esm
        OutExtension:
          - .js=.mjs

  ProcessFeedbackLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: pivotr-process-feedback
      Handler: index.handler
      CodeUri: lambda/process-feedback/
      Layers:
        - !Ref SharedUtilsLayer
      Timeout: 10
      MemorySize: 128
      ReservedConcurrentExecutions: 2
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        Minify: false
        Target: es2022
        External:
          - "@aws-sdk/*"
          - "@aws-lambda-powertools/*"
        Format: esm
        OutExtension:
          - .js=.mjs

  # ===========================================================================
  # Campaign Orchestration Lambda Functions
  # ===========================================================================

  CampaignProcessorLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: pivotr-campaign-processor
      Handler: index.handler
      CodeUri: lambda/campaign-processor/
      Layers:
        - !Ref SharedUtilsLayer
      Timeout: 55
      MemorySize: 256
      ReservedConcurrentExecutions: 1
      Environment:
        Variables:
          SQS_VERIFICATION_QUEUE_URL: !Ref VerificationQueueUrl
          SQS_SENDING_QUEUE_URL: !Ref SendingQueueUrl
      # Note: In production, triggered by EventBridge every minute
      # For local testing, invoke directly with: sam local invoke CampaignProcessorLambda
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        Minify: false
        Target: es2022
        External:
          - "@aws-sdk/*"
          - "@aws-lambda-powertools/*"
        Format: esm
        OutExtension:
          - .js=.mjs

  BulkVerifyLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: pivotr-bulk-verify
      Handler: index.handler
      CodeUri: lambda/bulk-verify/
      Layers:
        - !Ref SharedUtilsLayer
      Timeout: 30
      MemorySize: 256
      ReservedConcurrentExecutions: 1
      Environment:
        Variables:
          SQS_SENDING_QUEUE_URL: !Ref SendingQueueUrl
      Events:
        VerifyLeads:
          Type: Api
          Properties:
            RestApiId: !Ref PivotrMailerApi
            Path: /campaigns/{id}/verify
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
        Minify: false
        Target: es2022
        External:
          - "@aws-sdk/*"
          - "@aws-lambda-powertools/*"
        Format: esm
        OutExtension:
          - .js=.mjs

  # ===========================================================================
  # CloudWatch Alarms - Cost & Usage Monitoring (Conservative for 2 users)
  # ===========================================================================

  # Alert when total API invocations exceed expected for 2 users
  HighApiInvocationsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: pivotr-high-api-invocations
      AlarmDescription: Alert when API invocations exceed expected threshold for 2 users (500/day)
      Namespace: AWS/ApiGateway
      MetricName: Count
      Dimensions:
        - Name: ApiName
          Value: !Ref PivotrMailerApi
      Statistic: Sum
      Period: 86400
      EvaluationPeriods: 1
      Threshold: 500
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  # Alert on Lambda errors
  LambdaErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: pivotr-lambda-errors
      AlarmDescription: Alert when Lambda errors exceed threshold
      Namespace: AWS/Lambda
      MetricName: Errors
      Statistic: Sum
      Period: 3600
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  # Alert on API Gateway 4xx errors (client errors, potential abuse)
  Api4xxErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: pivotr-api-4xx-errors
      AlarmDescription: Alert when 4xx errors exceed threshold (potential abuse or misconfiguration)
      Namespace: AWS/ApiGateway
      MetricName: 4XXError
      Dimensions:
        - Name: ApiName
          Value: !Ref PivotrMailerApi
      Statistic: Sum
      Period: 3600
      EvaluationPeriods: 1
      Threshold: 50
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  # Alert on API Gateway 5xx errors (server errors)
  Api5xxErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: pivotr-api-5xx-errors
      AlarmDescription: Alert when 5xx errors exceed threshold (server issues)
      Namespace: AWS/ApiGateway
      MetricName: 5XXError
      Dimensions:
        - Name: ApiName
          Value: !Ref PivotrMailerApi
      Statistic: Sum
      Period: 3600
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  # Alert on throttled requests (hitting rate limits)
  ThrottledRequestsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: pivotr-throttled-requests
      AlarmDescription: Alert when requests are being throttled
      Namespace: AWS/Lambda
      MetricName: Throttles
      Statistic: Sum
      Period: 3600
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

# =============================================================================
# OUTPUTS
# =============================================================================
Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub "https://${PivotrMailerApi}.execute-api.${AWS::Region}.amazonaws.com/${PivotrMailerApi.Stage}"

  ApiEndpointLocal:
    Description: API Gateway local endpoint URL (SAM local)
    Value: !Sub "http://localhost:3000/${PivotrMailerApi.Stage}"

  ApiId:
    Description: API Gateway REST API ID
    Value: !Ref PivotrMailerApi

  ApiKeyId:
    Description: API Key ID (retrieve value from AWS Console or CLI)
    Value: !Ref PivotrApiKey

  UsagePlanId:
    Description: Usage Plan ID
    Value: !Ref PivotrApiUsagePlan

  SendEmailLambdaArn:
    Description: Send Email Lambda ARN
    Value: !GetAtt SendEmailLambda.Arn

  VerifyEmailLambdaArn:
    Description: Verify Email Lambda ARN
    Value: !GetAtt VerifyEmailLambda.Arn

  ProcessFeedbackLambdaArn:
    Description: Process Feedback Lambda ARN
    Value: !GetAtt ProcessFeedbackLambda.Arn

  CampaignProcessorLambdaArn:
    Description: Campaign Processor Lambda ARN
    Value: !GetAtt CampaignProcessorLambda.Arn

  BulkVerifyLambdaArn:
    Description: Bulk Verify Lambda ARN
    Value: !GetAtt BulkVerifyLambda.Arn
